include         /usr/local/etc/openldap/schema/core.schema
include         /usr/local/etc/openldap/schema/cosine.schema
include         /usr/local/etc/openldap/schema/inetorgperson.schema
include         /usr/local/etc/openldap/schema/nis.schema
include         /usr/local/etc/openldap/schema/esmile.schema
include         /usr/local/etc/openldap/schema/samba.schema
include         /usr/local/etc/openldap/schema/emmailaux.schema

pidfile         /usr/local/var/run/slapd.pid
argsfile        /usr/local/var/run/slapd.args

# ================= モジュール =================
# modulepath  /usr/local/openldap-2.6.10/libexec/openldap
modulepath  /usr/local/libexec/openldap
moduleload  back_mdb.la
moduleload  syncprov.la
moduleload  sssvlv.la
moduleload  ppolicy.la
moduleload  rwm.la
moduleload  back_ldap.la


# ================= グローバルアクセス制御（既存のまま） =================
# access to dn.base="" by * read
# access to dn.base="cn=Subschema" by * read
# access to *
#    by dn.exact="cn=admin,dc=e-smile,dc=ne,dc=jp" write
#    by dn.exact="gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth" write
#    by self write
#    by group.exact="cn=ldapusers,ou=Groups,dc=e-smile,dc=ne,dc=jp" read
#    by users read
#    by anonymous auth

# ================= メインDB設定 =================
database        mdb
maxsize         1073741824
directory       /usr/local/var/openldap-data
suffix          "dc=e-smile,dc=ne,dc=jp"
rootdn          "cn=admin,dc=e-smile,dc=ne,dc=jp"
rootpw          {SSHA}NjGmWJPN6awr3upV1dUgUvLrDSI2U9l5

index           objectClass     eq

# --- frontend / global ACL（順序厳守） ---
# {0} 機微属性（パスワード等）は厳格に
access to attrs=userPassword,shadowLastChange,shadowWarning,sambaNTPassword,sambaPwdLastSet
    by dn.base="gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth" manage
    by dn.base="cn=admin,dc=e-smile,dc=ne,dc=jp" write
    by self write
    by anonymous auth
    by * auth

# {1} ルートDSE / Subschema は誰でも参照可
access to dn.base=""
    by * read
access to dn.base="cn=subschema"
    by * read

# {2} その他すべて
access to *
    by dn.base="gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth" write
    by dn.base="cn=admin,dc=e-smile,dc=ne,dc=jp" write
    by self write
    by group.exact="cn=ldapusers,ou=Groups,dc=e-smile,dc=ne,dc=jp" read
    by users read
    by * read
    by anonymous auth

# {3} AddressBook
# access to dn.subtree="ou=AddressBook,dc=e-smile,dc=ne,dc=jp"
#  by peername.ip=192.168.0.0%255.255.0.0 read
#  by users read
#  by * none


# ================= モニターDB（内部監視用） =================
database        monitor
access to dn.subtree="cn=Monitor"
    by dn.base="cn=admin,dc=e-smile,dc=ne,dc=jp" read
    by * none

# ================= 設定用DB（cn=config 管理） =================
database        config
access to *
    by dn.base="gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth" manage
    by * none

